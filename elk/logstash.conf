input {
  tcp {
    port => 5000
    codec => json_lines
  }
}

filter {
  # Parse timestamp
  date {
    match => ["@timestamp", "ISO8601"]
    target => "@timestamp"
  }
  
  # Extract and enrich trace information
  if [traceId] {
    mutate {
      add_field => { "trace_id" => "%{traceId}" }
    }
  }
  
  if [spanId] {
    mutate {
      add_field => { "span_id" => "%{spanId}" }
    }
  }
  
  # Add tags based on log level
  if [level] == "ERROR" {
    mutate {
      add_tag => ["error"]
    }
  } else if [level] == "WARN" {
    mutate {
      add_tag => ["warning"]
    }
  } else if [level] == "INFO" {
    mutate {
      add_tag => ["info"]
    }
  }
  
  # Extract application info
  if [app_name] {
    mutate {
      add_field => { "application" => "%{app_name}" }
    }
  }
  
  # Parse exception stack traces
  if [stack_trace] {
    mutate {
      add_tag => ["exception"]
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "ecommerce-logs-%{[app_name]}-%{+YYYY.MM.dd}"
  }
  
  # Console output for debugging (can be disabled in production)
  stdout {
    codec => rubydebug
  }
}
